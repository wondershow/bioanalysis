
<html>
  <head>
  	<link rel="stylesheet" type="text/css" media="all" href="css/style.css">
  	<link rel="stylesheet" type="text/css" href="css/gsu.css">
	<!-- Page styles -->
	<link type='text/css' href='css/demo.css' rel='stylesheet' media='screen' />

	<!-- Contact Form CSS files -->
	<link type='text/css' href='css/basic.css' rel='stylesheet' media='screen' />
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="js/gsu.jslib.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    
  	<script type='text/javascript' src='js/jquery.js'></script>
	<script type='text/javascript' src='js/jquery.simplemodal.js'></script>
	<script type='text/javascript' src='js/basic.js'></script>
    
    

    <script type="text/javascript">
	  
	  var EMPTY_STRING = "N/A";
	  var NUM_OF_CHARTS_PER_LINE = 2;
	  var IF_TABLE_DRAWN = false;
      var x_field = null;
      var y_field = null;
      var z_field = null;
      var d_field = null;
	  
	  var num_of_charts = 1;
		
	  //To indicate how many charts have been assigned place to display
	  var allocated_charts = 0;
	  

	  var HTML_COLORS = [ "green","orange", "black", "blue","red", "fuchsia", "gray", "lime", "maroon", "navy", "olive", "purple","silver", "teal", "white",  "yellow"];
	  

      // Load the Visualization API and the controls package.
      google.load('visualization', '1.0', {'packages':['controls',"table"]});

      // Set a callback to run when the Google Visualization API is loaded.
      //google.setOnLoadCallback(drawDashboarHTML_COLORSd);
      
      
	 
	

	  /**
	  To define the point size and color according to user selected dimension,
	  the definition is generated according to object literal notation
	  **/	
	  function generatePointDescription(d_value,z_value,fullDataSet) {

		var d_dataset = getDistinctiveValues(d_field,fullDataSet);
		
		var index_of_color;
		if(d_value == "" || d_value == undefined)	
			index_of_color = arrayContains(d_dataset,EMPTY_STRING);
		else
			index_of_color = arrayContains(d_dataset,d_value);
		
		var color_name = HTML_COLORS[index_of_color];

		var pointSize = -1;

		var res = "";
		if(z_value != null && z_value != "") {
			pointSize = getPointSize(z_value,fullDataSet);
			res = 'point { size : ' + pointSize +';fill-color:' + color_name;
		} else 			
		res = 'point { fill-color:' + color_name;
		return res;
	  }

	function getDistinctiveValues(fieldName,dataSet) {
		var res = [];
		var index = getColNum(dataSet[0],fieldName);
		var i = 1;
		for(;i<dataSet.length;i++) {
			if(dataSet[i][index]==undefined || dataSet[i][index] == ""){
				if(arrayContains(res,EMPTY_STRING) == false) {
					res.push(EMPTY_STRING);
				}
			} else if(arrayContains(res,dataSet[i][index]) === false) {
				//console.log("The array is " + res + ", I am adding " + 	dataSet[i][index] + ",The return value is "
				//+ arrayContains(r<link rel="stylesheet" type="text/css" href="mystyle.css">es,dataSet[i][index]) )
				res.push(dataSet[i][index]);
			}
		}	
		return res;
	}

	function getPointSize(size,fullDataSet) {
		var sizeArr = getDistinctiveValues(z_field,fullDataSet);
		var max = getMax(sizeArr);
		var min = getMin(sizeArr);  
		res = Math.round( 10 * ((size-min)/(max-min)) ) + 3;
		return res;
	}

	function getAllInfo(row,fullDataSet) {
		res = "";
		var i=0;
		for(;i<fullDataSet[0].length;i++)
			res += fullDataSet[0][i] + ":" + fullDataSet[row][i] + "\n";
		return res;
	}

	function createLegend(fullDataSet,div_id) {
		var d_dataset = getDistinctiveValues(d_field,fullDataSet);
		var i=0;
		var color_name;
		
		
		//legend_div.innerHTML = "";
		//var legend_table = $("#"+div_id).append("<table> </table>");
		//legend_table.innerHTML = "";
		var orig_html = "<table>";
		for(;i<d_dataset.length;i++) {
			//orig_html = legend_table.innerHTML;
			color_name = HTML_COLORS[i];
			//'+ d_dataset[i] +
			var tmp;
			if (d_dataset[i]==undefined || d_dataset[i]=="")
				tmp = '<td>'+EMPTY_STRING+'</td><td><div class="circleBase type1" style="background-color:'+color_name+'"></div></td>';
			else 
				tmp = '<td>'+d_dataset[i]+'</td><td><div class="circleBase type1" style="background-color:'+color_name+'"></div></td>';
			//legend_table.innerHTML = orig_html + tmp;
			//console.log("tmp = " + tmp);
			orig_html = orig_html + tmp;
			
		}
		
		orig_html += "</table>";
		
		$("#"+div_id).append(orig_html);
		//legend_div.style.visibility="visible";
		
	}
	
	
	function getTicks(fullDataSet,dataField) {
		var headLine = fullDataSet[0];
		var col = getColNum(headLine,dataField);
		var max = (fullDataSet[col][0]=="" || fullDataSet[col][0]==undefined )?  0:fullDataSet[col][0];
		var min = (fullDataSet[col][0]=="" || fullDataSet[col][0]==undefined )?  100:fullDataSet[col][0];
		var i = 1;
		for(;i<fullDataSet[col].length;i++) {
			if(fullDataSet[col][i]!=undefined && fullDataSet[col][i] != "" && fullDataSet[col][i]>max)
				max = fullDataSet[col][i];
				
			if(fullDataSet[col][i]!=undefined && fullDataSet[col][i] != "" && fullDataSet[col][i]<max)
				min = fullDataSet[col][i];
		}
		
		var range = max - min;
		var res = [min, min+range/5, min + range*2/5, min+range*3/5, min+range*4/5, max];
		return res;
	}

    // Callback that creates and populates a data table,
    // instantiates a dashboard, a range slider and a pie chart,
    // passes in the data and draws it.
    function drawDashboard(fullDataSet,div_id) {
		console.log("div_id = " + div_id);
		
		
		var headLine = fullDataSet[0];
		var x_col = getColNum(headLine,x_field);
		var y_col = getColNum(headLine,y_field);
		var z_col = getColNum(headLine,z_field);
		var d_col = getColNum(headLine,d_field);
      
		var data_tbl = new google.visualization.DataTable();
        data_tbl.addColumn('number', x_field);
        data_tbl.addColumn('number', y_field);
		
		//Get the enumeration of all the possible values of d_field(no copy values)
		d_dataset = getDistinctiveValues(d_field,fullDataSet);
		
		var x_filter_id = "chart_" + allocated_charts + "_x_filter";
		var y_filter_id = "chart_" + allocated_charts + "_y_filter";
		var z_filter_id = "chart_" + allocated_charts + "_z_filter";
		var legend_id = "chart_" + allocated_charts + "_legend";
		var chart_id = "chart_" + allocated_charts + "_div";
		
		console.log("legend_id = " + legend_id);
		
		//add the div to hold legends
		$("#"+div_id).append("<div id = '"+ legend_id +"'  align='center' style='background-color:yellow'> </div>");
		
		/*
        var i =1;
        for(;i<fullDataSet.length;i++) {
	  		data_tbl.addRow([parseInt(fullDataSet[i][x_col]),parseInt(fullDataSet[i][y_col])  ]);
        }*/
		
		var pntDesc = generatePointDescription(fullDataSet[1][d_col],null,fullDataSet);
		
        data_tbl = google.visualization.arrayToDataTable
            ([[x_field, y_field, {'type': 'string', 'role': 'style'},{type: 'string', role: 'tooltip'}],
              [parseInt(fullDataSet[1][x_col]), parseInt(fullDataSet[1][y_col]), pntDesc,'xyz']
        ]);
		
		var i =2;
		
        for(;i<fullDataSet.length;i++) {
			if(z_field!=null)
				pntDesc = generatePointDescription(fullDataSet[i][d_col],fullDataSet[i][z_col],fullDataSet);
			else
				pntDesc = generatePointDescription(fullDataSet[i][d_col],null,fullDataSet);
	  		data_tbl.addRow([parseInt(fullDataSet[i][x_col]),parseInt(fullDataSet[i][y_col]),pntDesc,getAllInfo(i,fullDataSet)]);
        }
	
		console.log("asdf " + document.getElementById(div_id));
        // Create a dashboard.
        var dashboard = new google.visualization.Dashboard(document.getElementById(div_id));

        // Create a range slider, passing some options
		$("#"+div_id).append("<div id = '"+ x_filter_id +"' align='center'> </div>");
        var donutRangeSlider = new google.visualization.ControlWrapper({
          'controlType': 'NumberRangeFilter',
          'containerId': x_filter_id,
          'options': {
            'filterColumnLabel': x_field
          }
        });
        
		$("#"+div_id).append("<div id = '"+ y_filter_id +"'   align='center'> </div>");
        // Create a range slider, passing some optionsdashboard_div
        var donutRangeSlider1 = new google.visualization.ControlWrapper({
          'controlType': 'NumberRangeFilter',
          'containerId': y_filter_id,
          'options': {
            'filterColumnLabel': y_field
          }
        })
        
		/*
		// Create a range slider, passing some options
        var donutRangeSlider2 = new google.visualization.ControlWrapper({
          'controlType': 'CategoryFilter',
          'containerId': 'filter_div3',
          'options': {
            'filterColumnLabel': d_field
          }
        });*/
		
		
		
		
		$("#"+div_id).append("<div id = '"+ chart_id +"'  align='center'> </div>");
		
        // Create a pie chart, passing some options
        var pieChart = new google.visualization.ChartWrapper({
          'chartType': 'ScatterChart',
          'containerId': chart_id,
          'options': {
            'width': screen.width * 0.5,
            'height': screen.height * 0.5,
            'legend': 'none',
            'align':'right',
			'chartArea': {'width': '80%', 'height': '90%'},
			'hAxis': {
						//'slantedText': 'true', 
						//'slantedTextAngle': '90', 
						//'title': 'titleText',
						//'viewWindow': { min: 0,max: 25},
						//'ticks': [0, 7, 14, 21, 28],
						//title: 'titleText'
					 },
			'vAxis': {
						title: y_field
					 },
          }
        });
		
		


        // Establish dependencies, declaring that 'filter' drives 'pieChart',
        // so that the pie chart will only display entries that are let through
        // given the chosen slider range.
        dashboard.bind
        (donutRangeSlider, pieChart);
		dashboard.bind(donutRangeSlider1, pieChart);
		//dashboard.bind(donutRangeSlider2, pieChart);

        // Draw the dashboard.
        dashboard.draw(data_tbl);
	
		createLegend(fullDataSet,legend_id);
		
		if(IF_TABLE_DRAWN==false) {
			drawTable(fullDataSet);
		}
      }

      function draw() {
		
		
		
		//To update the number of charts have been drawn on the screen
		num_of_charts++;
		
		var tmp;
		tmp = document.getElementById("x_field");
		x_field = tmp.options[tmp.selectedIndex].value;

		tmp = document.getElementById("y_field");
		y_field = tmp.options[tmp.selectedIndex].value;
		
		tmp = document.getElementById("z_field");
		z_field = tmp.options[tmp.selectedIndex].value;

		tmp = document.getElementById("d_field");
		d_field = tmp.options[tmp.selectedIndex].value;

		if ( x_field=="" || y_field=="" || d_field == "") {
		  document.getElementById("alertmsg").innerHTML = "Please select field X, Y and Data";
		} else if( x_field == y_field) {
		  document.getElementById("alertmsg").innerHTML = "Field X and Y are same";
		} else if( y_field == z_field) {
		  document.getElementById("alertmsg").innerHTML = "Field Y and Z are same";
		} else if( x_field == z_field) {
		  document.getElementById("alertmsg").innerHTML = "Field X and Z are same";
		} else {
		  document.getElementById("alertmsg").innerHTML = "";
		  getCSVData();
		}
		$.modal.close();
	}
	
	function getCSVData(){
	    $.ajax("http://76.114.185.215/bioanalysis/google/cancer.csv", {
			success: function(data) {
				processData(data);
			},
			error: function() {
			// Show some error message, couldn't get the CSV file
			}
	    });
	}
	
	function processData(data) {
		dataArray = CSVToArray(data);
		var div_id = getDivIDInTableCell();
		drawDashboard(dataArray,div_id);	
		
	}
	
	function drawTable(fullDataSet) {
		IF_TABLE_DRAWN = true;
		var div_id = getDivIDInTableCell();
		console.log("div_id = " + div_id);
		var data = new google.visualization.DataTable();
		var i=0,j=0;
		var dim = fullDataSet[0].length;
		for(;i<fullDataSet[0].length;i++) 
			data.addColumn('string',fullDataSet[0][i]);
		for(i=1;i<fullDataSet.length;i++) {
			var row = [];
			for(j=0;j<dim;j++) {
				if(fullDataSet[i][j] == undefined || fullDataSet[i][j] == "")
					row.push(EMPTY_STRING);
				else
					row.push(fullDataSet[i][j]);
			}
			data.addRow(row);
		}
		
		
		var table = new google.visualization.Table(document.getElementById(div_id));
		var options = {
            width: screen.width * 0.48,
            height: screen.height * 0.48
		}
		table.draw(data,options);
	}
	
	//To return a div id in table cell to put chart in
	function getDivIDInTableCell() {
		allocated_charts++;
	
		var lines = Math.ceil (num_of_charts/NUM_OF_CHARTS_PER_LINE);
		
		var cell_div_num = allocated_charts;
		
		
		
		//we need to add a new line to the table
		if( allocated_charts % NUM_OF_CHARTS_PER_LINE  == 1) {
			var added_html_code = "";
			var i=0;
			added_html_code += "<tr style='border: 2px solid black;border-collapse: collapse;'>";
			for(;i<NUM_OF_CHARTS_PER_LINE;i++){
				var id = "chart_div_" +  (cell_div_num+i);
				added_html_code += "<td> <div id='" +   id  + "' style='border: 2px solid black;border-collapse: collapse;'> </div></td>";
			}
			added_html_code += "</tr>";
			$("#main_table").append(added_html_code);
		}
		return "chart_div_" + cell_div_num;
	}
    </script>
    
    
  
	</head>
	
  <body>
	<div id='content'>
		<div id='basic-modal'>
			<a class="flatbtn" id="modaltrigger">+</a>
		</div>
		
		<!-- modal content -->
		<div id="basic-modal-content">
			
		<table class="fixed" style="background-color:#99CCFF;width:100%;height=100%;padding=5px; border: 2px solid black;border-collapse: collapse;" align="center">
			<col width="50%" />
    		<col width="50%" />
			<tr style="border: 2px solid black;border-collapse: collapse;">
				<td style="border: 2px solid black;border-collapse: collapse;"> 
					X: 
				</td>
				<td style="border: 2px solid black;border-collapse: collapse;">
					<select id="x_field">
						<option></option>
						<option>NucCount</option>
				        <option>PH3</option>
						<option>KI67</option>
						<option>t</option>
						<option>Age</option>
						<option>MFI</option>
						<option>KI67_Percent</option>
						<option>PH3_Percent</option>
	 				</select>
				</td>
			</tr>
			<tr style="border: 2px solid black;border-collapse: collapse;">
				<td style="border: 2px solid black;border-collapse: collapse;"> 
					Y:
				</td>
				<td style="border: 2px solid black;border-collapse: collapse;">
					<select id="y_field">
						<option></option>
						<option>NucCount</option>
				        <option>PH3</option>
						<option>KI67</option>
						<option>t</option>
						<option>Age</option>
						<option>MFI</option>
						<option>KI67_Percent</option>
						<option>PH3_Percent</option>
	 				</select>
				</td>
			</tr>
			<tr style="border: 2px solid black;border-collapse: collapse;">
				<td style="border: 2px solid black;border-collapse: collapse;"> 
					Size:
				</td>
				<td style="border: 2px solid black;border-collapse: collapse;">
					<select id="z_field">
						<option></option>
						<option>NucCount</option>
						<option>PH3</option>
						<option>KI67</option>
						<option>t</option>
						<option>Age</option>
						<option>MFI</option>
						<option>KI67_Percent</option>
						<option>PH3_Percent</option>
	 				</select>
				</td>
			</tr>
			<tr style="border: 2px solid black;border-collapse: collapse;">
				<td style="border: 2px solid black;border-collapse: collapse;"> 
					Color:draw
				</td>
				<td style="border: 2px solid black;border-collapse: collapse;">
					<select id="d_field">
						<option></option>
						<option>UpGrade</option>
						<option>UpNot</option>
						<option>Grade</option>
						<option>Notin</option>
						<option>gland</option>
						<option>mi</option>
						<option>checkNot</option>
						<option>pt</option>
						<option>Stages</option>
						<option>Race</option>
						<option>ER</option>
						<option>PR</option>
						<option>HER2</option>
						<option>HER2Status</option>
						<option>TN</option>
						<option>Tstage</option>
						<option>Nstage</option'center'>
						<option>Final_Grade</option>
						<option>Final_Not</option>
						<option>AdjustedNot</option>
						<option>Adjusted1</option>
	 				</select>
				</td>
			</tr>
			<tr style="border: 2px solid black;border-collapse: collapse;">
				<td align='center'  colspan=2 style="border: 2px solid black;border-collapse: collapse;">
					<button id='drawbutton' onclick="draw()"> Draw</button>
			    </td>
			</tr>
			<tr style="border: 2px solid black;border-collapse: collapse;">
			    <td colspan=2 style="border: 2px solid black;border-collapse: collapse;">
				<font color="red" size="5"  face="courier" id="alertmsg"></font> 
			    </td>
			</tr>
		</table>
		</div>

		<!-- preload the images -->
		
		<div style='display:none'>
			<img src='img/basic/x.png' alt='' />
		</div> 
	</div>
	
	
	

	
	
	
	<!--  
    <h1>User Login</h1>
    <form id="loginform" name="loginform" method="post" action="index.html">
      <label for="username">Username:</label>
      <input type="text" name="username" id="username" class="txtfield" tabindex="1">
      
      <label for="password">Password:</label>
      <input type="password" name="password" id="password" class="txtfield" tabindex="2">
      
      <div class="center"><input type="submit" name="loginbtn" id="loginbtn" class="flatbtn-blu hidemodal" value="Log In" tabindex="3"></div>
    </form>-->

    <!--Div that will hold the dashboard-->
    <div id="dashboard_div"> </div>
	<div id='legend' style="visibility: hidden; display:inline; width:80%" align = "center">
		<table style="background-color:#99CCFF;" align = "center" >
			<tr id = 'legend_table'>
				<td>
					
				</td>
			</tr>
		</table>
	</div>
	
	
	<div id='firstchart'>
		<div id="filter_div"></div>
		<div id="filter_div2"></div>
		<div id="filter_div3"></div>
		<div id="chart_div"></div>
    	</div>
    </div>
	
	<table id="main_table" style="border: 2px solid black;border-collapse: collapse;" >
		
	</table>
  </body>
</html>
